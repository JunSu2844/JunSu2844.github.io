---
layout: post
published : false  # 글 비공개 설정
title: "[드림핵][Lv.1] CSRF Advanced 문제 풀이"
date:   2025-07-16 13:00:00 +0900
categories: [Security]
tags: [wargame, web, csrf]
---

## 1. 개요 (Overview)

- **플랫폼 (Platform)**: 드림핵
- **문제 이름 (Challenge)**: CSRF Advanced
- **분야 (Category)**: 웹해킹
- **문제 링크 (URL)**: [드림핵 워게임](https://dreamhack.io/wargame/challenges/442)

<br>

---

## 2. 문제 분석 (Problem Analysis)

```python

# Xss 필터
xss_filter = ["frame", "script", "on"]

#세션 토큰 MD5 암호처리
token_storage[session_id] = md5((username + request.remote_addr).encode()).hexdigest()

# 비밀번호 변경
@app.route("/change_password")

def change_password():

	session_id = request.cookies.get('sessionid', None)

	try:
		username = session_storage[session_id]
		csrf_token = token_storage[session_id]

	except KeyError:
		return render_template('index.html', text='please login')
	pw = request.args.get("pw", None)
	if pw == None:
		return render_template('change_password.html', csrf_token=csrf_token)

		else:
			if csrf_token != request.args.get("csrftoken", ""):
				return '<script>alert("wrong csrf token");history.go(-1);</script>'
			users[username] = pw
				return '<script>alert("Done");history.go(-1);</script>'


# token_storage[session_id] = md5((username + request.remote_addr).encode()).hexdigest()

# admin의 경우
username = 'admin'
remote_addr = '127.0.0.1'

# admin의 CSRF 토큰 값
csrf_token = md5(('admin' + '127.0.0.1').encode()).hexdigest()
```

### 1) 문제 해설
- 이 문제의 핵심은 CSRF 취약점을 이용해 admin의 비밀번호를 변경하는 것이 목표다.


#### 1-1) `request.remote_addr`와 CSRF 토큰의 이해
- `request.remote_addr` 란?
	- Flask에서 이 값은 서버의 요청을 보낸 클라이언트으 IP 주소를 의미
	- 이 문제에서 admin 봇(read_url)를 보면 이 봇이 admin의 행동을 흉내 내면서
	  웹 애플리케이션과 동일한 한경(서버) 내에서 실행된다.
	- 결론적으로 admin의 request.remote_addr 값은 항상 127.0.0.1 이다.


#### 1-2) 취약점 연결
- 우리는 일단 /flag 페이지에서 param 값을 POST 방식을 전송해야 한다.
- 서버는 check_csrf 함수를 호출하고, 이 함수는 read_uirl 함수를 실행하게 된다. 
- admin은 우리가 보낸 param 값이 담긴 페이로드의 URL에 접속하고, 이 때 /vuln 페이지에 XSS 취약점이 존재하게 된다. 
- 아무리 XSS 필터링을 하더라도, 우회가 가능하기 때문이다.
- 우리는 XSS 이용해서 admin의 브라우저가 CSRF 공격을 수행하도록 만들어야 한다.


#### 1-3) 페이로드 작성
- 먼저 /flag 페이제 param 값이  POST 방식의 페이로드를 집어넣어, admin이 페이로드의 URL에 접속하게 해야 한다.
- 이 때 xss 필터링을 우회해야 하게 때문에
- script, on, fream 등은 사용하면 안된다.
- 그래서 우리는 img 태그를 활용해서 페이로드를 작성 할 것이다.

~~~python
<img src="/change_password?pw=pwned&csrftoken=[여기다가_계산한_토큰값]">
~~~

- 일단 페이로드 구상은 했다.
- 이제는 CSRF 토큰을 계산해야 한다.
- 위에 MD5(admin+127.0.0.1) 했다는걸 우리는 소스코드를 통해 확인 했다.
- 이제 CSRF 토큰을 계산해야 한다. 이 방법은 파이썬 코드를 활용해 계산을 해보았다.

~~~python
from hashlib import md5

admin_token = md5(b'admin127.0.0.1').hexdigest()
print(admin_token) 
# 출력 결과: 7505b9c72ab4aa94b1a4ed7b207b67fb

~~~

- 이제 확인된 CSRF 토큰값을 넣어서 /flag 페이지의 입력 폼에 넣어보고, /login 페이지에 접속

~~~python
<img src="/change_password?pw=pwned&csrftoken=7505b9c72ab4aa94b1a4ed7b207b67fb">
~~~

- 아이디 : admin
- 비번 : pwned
- 입력하게 되면 flag 값을 확인 할 수 있을 것이다.

---
